name: "Set Environment Variables from config files"
description: "A reusable action to set environment variables from a JSON file"
inputs:
  global_config_repo:
    description: "Repo containing global config JSON file"
    required: true
    default: cloudopsaas/global-config
  global_config_version:
    description: "Version of the global config JSON file, specified as git tag"
    required: true
  github_token:
    description: "GITHUB TOKEN for checking out private repo"
    required: true
  global_config_file_path:
    description: "Path to the global module config JSON file"
    required: true
    default: "lz/global_config.json"
  module_config_file_path:
    description: "Path to the local module config JSON file"
    required: true
    default: "config/module_config.json"
  temp_workspace:
    description: "Name of the local folder where we checkout the global config repo"
    required: true
    default: "temp_global_config"
  
  
runs:
  using: "composite"
  steps:
    - name: create temp workspace 
      shell: bash
      run: |
        mkdir ${{ inputs.temp_workspace }}

    - name: Checkout the global config repository
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.global_config_repo }}
        ref: ${{ inputs.global_config_version }} 
        token: ${{ inputs.github_token }}
        path: ${{ inputs.temp_workspace }}

    - name: Read global config JSON and set environment variables
      shell: bash
      working-directory: ${{ inputs.temp_workspace }}
      run: |
        for key in $(jq -r '.env_variables | keys[]' ${{ inputs.global_config_file_path }}); do
          value=$(jq -r ".env_variables[\"$key\"]" ${{ inputs.global_config_file_path }})
          echo "$key=$value" >> $GITHUB_ENV
        done
    - name: Read module config JSON and set environment variables
      shell: bash
      run: |
        for key in $(jq -r '.env_variables | keys[]' ${{ inputs.module_config_file_path }}); do
          value=$(jq -r ".env_variables[\"$key\"]" ${{ inputs.module_config_file_path }})
          echo "$key=$value" >> $GITHUB_ENV
        done
    
